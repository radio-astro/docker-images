/*
Copyright:    (C) 2014 Emmanuel Bertin - IAP/CNRS/UPMC,
                       Chiara Marmo - IDES/Paris-Sud,
                       Ruven Pillay - C2RMF/CNRS
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are
permitted provided that the following conditions are met:

   1. Redistributions of source code must retain the above copyright notice, this list of
      conditions and the following disclaimer.

   2. Redistributions in binary form must reproduce the above copyright notice, this list
      of conditions and the following disclaimer in the documentation and/or other materials
      provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

if("undefined"!=typeof require)var $=require("jquery-browser");if($.extend($.fn,{fileTree:function(t,e){void 0===t.root&&(t.root="/"),void 0===t.script&&(t.script="dist/filetree.php"),void 0===t.folderEvent&&(t.folderEvent="click"),void 0===t.expandSpeed&&(t.expandSpeed=500),void 0===t.collapseSpeed&&(t.collapseSpeed=500),void 0===t.expandEasing&&(t.expandEasing=null),void 0===t.collapseEasing&&(t.collapseEasing=null),void 0===t.multiFolder&&(t.multiFolder=!0),void 0===t.loadMessage&&(t.loadMessage="Loading..."),$(this).each(function(){function i(e,i){$(e).addClass("wait"),$(".filetree.start").remove(),$.post(t.script,{dir:i},function(a){$(e).find(".start").html(""),$(e).removeClass("wait").append(a),t.root===i?$(e).find("UL:hidden").show():$(e).find("UL:hidden").slideDown({duration:t.expandSpeed,easing:t.expandEasing}),o(e)})}function o(o){$(o).find("LI A").on(t.folderEvent,function(){return $(this).parent().hasClass("directory")?$(this).parent().hasClass("collapsed")?(t.multiFolder||($(this).parent().parent().find("UL").slideUp({duration:t.collapseSpeed,easing:t.collapseEasing}),$(this).parent().parent().find("LI.directory").removeClass("expanded").addClass("collapsed")),$(this).parent().find("UL").remove(),i($(this).parent(),encodeURI($(this).attr("rel").match(/.*\//))),$(this).parent().removeClass("collapsed").addClass("expanded")):($(this).parent().find("UL").slideUp({duration:t.collapseSpeed,easing:t.collapseEasing}),$(this).parent().removeClass("expanded").addClass("collapsed")):e($(this).attr("rel")),!1}),"click"!==t.folderEvent.toLowerCase&&$(o).find("LI A").on("click",function(){return!1})}$(this).html('<ul class="filetree start"><li class="wait">'+t.loadMessage+"<li></ul>"),i($(this),encodeURI(t.root))})}}),L.IIPUtils={REG_PDEC:"(\\d+\\.\\d*)",REG_FLOAT:"([-+]?[0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",requestURI:function(t,e,i,o){var a;if(window.XMLHttpRequest)a=new XMLHttpRequest;else if(window.ActiveXObject)try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{a=new ActiveXObject("Microsoft.XMLHTTP")}catch(n){}}return a?(a.open("GET",t),a.onreadystatechange=function(){i(o,a)},a.send(),void 0):(alert("Giving up: Cannot create an XMLHTTP instance for "+e),!1)},distance:function(t,e){var i=Math.PI/180,o=t.lat*i,a=e.lat*i,n=a-o,s=(e.lng-t.lng)*i,r=Math.sin(n/2),l=Math.sin(s/2),p=r*r+l*l*Math.cos(o)*Math.cos(a);return 360*Math.atan2(Math.sqrt(p),Math.sqrt(1-p))/Math.PI}},L.Projection.WCS=L.Class.extend({bounds:L.bounds([-.5,-.5],[.5,.5]),_phiThetaToRADec:function(t){var e=this.projparam,i=Math.PI/180,o=180/Math.PI,a=t.lat*i,n=Math.cos(a),s=Math.sin(a),r=e.celpole.lat*i,l=Math.cos(r),p=Math.sin(r),c=(t.lng-e.natpole.lng)*i,h=Math.cos(c),u=s*p+n*l*h;return u>1?u=1:-1>u&&(u=-1),new L.LatLng(Math.asin(u)*o,e.celpole.lng+Math.atan2(-n*Math.sin(c),s*l-n*p*h)*o)},_raDecToPhiTheta:function(t){var e=this.projparam,i=Math.PI/180,o=180/Math.PI,a=(t.lng-e.celpole.lng)*i,n=Math.cos(a),s=Math.sin(a),r=t.lat*i,l=Math.cos(r),p=Math.sin(r),c=e.celpole.lat*i,h=Math.cos(c),u=Math.sin(c),d=p*u+l*h*n;return d>1?d=1:-1>d&&(d=-1),new L.LatLng(Math.asin(d)*o,e.natpole.lng+Math.atan2(-l*s,p*h-l*u*n)*o)},_pixToRed:function(t){var e=this.projparam,i=e.cd,o=t.subtract(e.crpix);return new L.Point(o.x*i[0][0]+o.y*i[0][1],o.x*i[1][0]+o.y*i[1][1])},_redToPix:function(t){var e=this.projparam,i=e.cdinv;return new L.point(t.x*i[0][0]+t.y*i[0][1],t.x*i[1][0]+t.y*i[1][1]).add(e.crpix)},_invertCD:function(t){var e=1/(t[0][0]*t[1][1]-t[0][1]*t[1][0]);return[[t[1][1]*e,-t[0][1]*e],[-t[1][0]*e,t[0][0]*e]]}}),L.Projection.WCS.PIX=L.Projection.WCS.extend({code:"PIX",paraminit:function(t){this.projparam=t,t.cdinv=this._invertCD(t.cd),t.natfid=new L.LatLng(0,90),t.celpole=t.crval,this.bounds=L.bounds([.5,this.projparam.naxis.y-.5],[this.projparam.naxis.x-.5,.5])},project:function(t){return L.point(t.lng,t.lat)},unproject:function(t){return L.latLng(t.y,t.x)}}),L.Projection.WCS.zenithal=L.Projection.WCS.extend({paraminit:function(t){this.projparam=t,t.cdinv=this._invertCD(t.cd),t.natfid=new L.LatLng(0,90),t.celpole=t.crval},project:function(t){var e=this._raDecToPhiTheta(t);return e.lat=this._thetaToR(e.lat),this._redToPix(this._phiRToRed(e))},unproject:function(t){var e=this._redToPhiR(this._pixToRed(t));return e.lat=this._rToTheta(e.lat),this._phiThetaToRADec(e)},_redToPhiR:function(t){return new L.LatLng(Math.sqrt(t.x*t.x+t.y*t.y),180*Math.atan2(t.x,-t.y)/Math.PI)},_phiRToRed:function(t){var e=Math.PI/180,i=t.lng*e;return new L.Point(t.lat*Math.sin(i),-t.lat*Math.cos(i))}}),L.Projection.WCS.TAN=L.Projection.WCS.zenithal.extend({code:"TAN",_rToTheta:function(t){return 180*Math.atan2(180,Math.PI*t)/Math.PI},_thetaToR:function(t){return 180/Math.PI*Math.tan((90-t)*Math.PI/180)}}),L.Projection.WCS.ZEA=L.Projection.WCS.zenithal.extend({code:"ZEA",_rToTheta:function(t){var e=Math.PI*t/360;return Math.abs(e)<1?90-180*2*Math.asin(e)/Math.PI:90},_thetaToR:function(t){return 360/Math.PI*Math.sin((90-t)*Math.PI/360)}}),L.CRS.WCS=L.extend({},L.CRS,{code:"WCS",options:{ctype:{x:"PIXEL",y:"PIXEL"},naxis:[256,256],nzoom:9,crpix:[129,129],crval:[0,0],cd:[[1,0],[0,1]],natpole:[90,180],tileSize:[256,256]},initialize:function(t,e){switch(e=L.setOptions(this,e),this.tileSize=L.point(e.tileSize),this.nzoom=e.nzoom,this.ctype={x:e.ctype.x,y:e.ctype.y},this.naxis=L.point(e.naxis,!0),this.projparam=new this.paraminit(e),t&&this._readWCS(t),this.ctype.x.substr(5,3)){case"ZEA":this.projection=new L.Projection.WCS.ZEA,this.pixelFlag=!1,this.infinite=!0;break;case"TAN":this.projection=new L.Projection.WCS.TAN,this.pixelFlag=!1,this.infinite=!0;break;default:this.projection=new L.Projection.WCS.PIX,this.pixelFlag=!0,this.infinite=!1,this.wrapLng=[.5,this.naxis.x-.5],this.wrapLat=[this.naxis.y-.5,.5]}this.transformation=new L.Transformation(1,-.5,-1,this.naxis.y+.5),this.projection.paraminit(this.projparam),this.code+=":"+this.projection.code},paraminit:function(t){this.naxis=L.point(t.naxis),this.crval=L.latLng(t.crval),this.crpix=L.point(t.crpix),this.cd=[[t.cd[0][0],t.cd[0][1]],[t.cd[1][0],t.cd[1][1]]],this.natpole=L.latLng(t.natpole),this.celpole=L.latLng(t.celpole),this.natfid=L.latLng(t.natfid)},scale:function(t){return Math.pow(2,t-this.nzoom+1)},pixelScale:function(t,e){var i=this.projection.project(e),o=this.projection.unproject(i.add([10,0])),a=this.projection.unproject(i.add([0,10]));return.1*Math.sqrt(Math.abs((o.lng-e.lng)*(a.lat-e.lat)-(a.lng-e.lng)*(o.lat-e.lat)))*Math.cos(e.lat*Math.PI/180)/this.scale(t)},_readWCS:function(t){var e,i=this._readFITSKey,o=this.projparam;(e=i("CTYPE1",t))&&(this.ctype.x=e),(e=i("CTYPE2",t))&&(this.ctype.y=e),(e=i("NAXIS1",t))&&(o.naxis.x=this.naxis.x=parseInt(e,10)),(e=i("NAXIS2",t))&&(o.naxis.y=this.naxis.y=parseInt(e,10)),(e=i("CRPIX1",t))&&(o.crpix.x=parseFloat(e,10)),(e=i("CRPIX2",t))&&(o.crpix.y=parseFloat(e,10)),(e=i("CRVAL1",t))&&(o.crval.lng=parseFloat(e,10)),(e=i("CRVAL2",t))&&(o.crval.lat=parseFloat(e,10)),(e=i("CD1_1",t))&&(o.cd[0][0]=parseFloat(e,10)),(e=i("CD1_2",t))&&(o.cd[0][1]=parseFloat(e,10)),(e=i("CD2_1",t))&&(o.cd[1][0]=parseFloat(e,10)),(e=i("CD2_2",t))&&(o.cd[1][1]=parseFloat(e,10))},_readFITSKey:function(t,e){var i=t.trim().toUpperCase().substr(0,8),o=8-i.length,a=new RegExp(i+"\\ {"+o.toString()+"}=\\ *(?:'(\\S*)\\ *'|([-+]?[0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?))"),n=a.exec(e);return n?n[1]?n[1]:n[2]:null}}),L.CRS.WCS=L.Class.extend(L.CRS.WCS),L.CRS.wcs=function(t){return new L.CRS.WCS(t)},L.TileLayer.IIP=L.TileLayer.extend({options:{title:"",minZoom:0,maxZoom:null,maxNativeZoom:18,noWrap:!0,contrast:1,gamma:1,cMap:"grey",invertCMap:!1,quality:90},iipdefault:{contrast:1,gamma:1,cMap:"grey",invertCMap:!1,minValue:[],maxValue:[],quality:90},initialize:function(t,e){return e=L.setOptions(this,e),e.detectRetina&&L.Browser.retina&&e.maxZoom>0&&(e.tileSize=Math.floor(e.tileSize/2),e.zoomOffset++,e.minZoom=Math.max(0,e.minZoom),e.maxZoom--),this._url=t.replace(/\&.*$/g,""),"string"==typeof e.subdomains&&(e.subdomains=e.subdomains.split("")),this.iipTileSize={x:256,y:256},this.iipImageSize=[],this.iipImageSize[0]=this.iipTileSize,this.iipGridSize=[],this.iipGridSize[0]={x:1,y:1},this.iipBPP=8,this.iipMinZoom=this.options.minZoom,this.iipMaxZoom=this.options.maxZoom,this.iipContrast=this.options.contrast,this.iipGamma=this.options.gamma,this.iipCMap=this.options.cMap,this.iipInvertCMap=this.options.invertCMap,this.iipMinValue=[],this.iipMinValue[0]=0,this.iipMaxValue=[],this.iipMaxValue[0]=255,this.iipQuality=this.options.quality,this._title=e.title.length>0?e.title:this._url.match(/^.*\/(.*)\..*$/)[1],this.getIIPMetaData(this._url),this},getIIPMetaData:function(t){L.IIPUtils.requestURI(t+"&obj=IIP,1.0&obj=max-size&obj=tile-size"+"&obj=resolution-number&obj=bits-per-channel"+"&obj=min-max-sample-values&obj=subject","getting IIP metadata",this._parseMetadata,this)},_parseMetadata:function(t,e){if(4===e.readyState)if(200===e.status){var i=e.responseText,o=t._readIIPKey(i,"IIP",L.IIPUtils.REG_PDEC);o||alert("Error: Unexpected response from IIP server "+t._url.replace(/\?.*$/g,"")),o=t._readIIPKey(i,"Max-size","(\\d+)\\s+(\\d+)");var a={x:parseInt(o[1],10),y:parseInt(o[2],10)};o=t._readIIPKey(i,"Tile-size","(\\d+)\\s+(\\d+)"),t.iipTileSize={x:parseInt(o[1],10),y:parseInt(o[2],10)},o=t._readIIPKey(i,"Resolution-number","(\\d+)"),t.iipMaxZoom=parseInt(o[1],10)-1,t.iipMinZoom>t.options.minZoom&&(t.options.minZoom=t.iipMinZoom),t.options.maxZoom||(t.options.maxZoom=t.iipMaxZoom+6),t.options.maxNativeZoom=t.iipMaxZoom;for(var n=0;n<=t.iipMaxZoom;n++)t.iipImageSize[n]={x:Math.floor(a.x/Math.pow(2,t.iipMaxZoom-n)),y:Math.floor(a.y/Math.pow(2,t.iipMaxZoom-n))},t.iipGridSize[n]={x:Math.ceil(t.iipImageSize[n].x/t.iipTileSize.x),y:Math.ceil(t.iipImageSize[n].y/t.iipTileSize.y)};for(n=t.iipMaxZoom;n<=t.options.maxZoom;n++)t.iipGridSize[n]=t.iipGridSize[t.iipMaxZoom];o=t._readIIPKey(i,"Bits-per-channel","(\\d+)"),t.iipBPP=parseInt(o[1],10),t.iipGamma=t.iipBPP>=32?2.2:1,o=t._readIIPKey(i,"Min-Max-sample-values","\\s*(.*)");for(var s=o[1].split(/\s+/),r=s.length/2,l=0,p=0;r>p;p++)t.iipdefault.minValue[p]=t.iipMinValue[p]=parseFloat(s[l++]);for(p=0;r>p;p++)t.iipdefault.maxValue[p]=t.iipMaxValue[p]=parseFloat(s[l++]);t.options.bounds&&(t.options.bounds=L.latLngBounds(t.options.bounds)),t.wcs=new L.CRS.WCS(i,{nzoom:t.iipMaxZoom+1,tileSize:t.iipTileSize,crval:L.latLng((a.y+1)/2,(a.x+1)/2)}),t.iipMetaReady=!0,t.fire("metaload")}else alert("There was a problem with the IIP metadata request.")},_readIIPKey:function(t,e,i){var o=new RegExp(e+":"+i);return o.exec(t)},addTo:function(t){return this.iipMetaReady?this._addToMap(t):this.once("metaload",function(){this._addToMap(t)},this),this},_addToMap:function(t){var e,i,o=this.wcs,a=t.options.crs,n=t._prevcrs;if(t._loaded&&(a._prevLatLng=t.getCenter(),a._prevZoom=t.getZoom()),n&&o!==a&&t._loaded&&o.pixelFlag===a.pixelFlag){e=a._prevLatLng,i=a._prevZoom;var s=n.pixelScale(i,e),r=o.pixelScale(i,e);s>1e-20&&r>1e-20&&(i+=Math.round(Math.LOG2E*Math.log(r/s)))}else o._prevLatLng?(e=o._prevLatLng,i=o._prevZoom):(e=t.options.center?t.options.center:o.projparam.crval,i=this.iipMinZoom);t._prevcrs=t.options.crs=o,t.setView(e,i,{reset:!0,animate:!1}),L.TileLayer.prototype.addTo.call(this,t)},_resetWrap:function(){var t=this._map,e=t.options.crs;if(!e.infinite&&!this.options.noWrap){var i=this._getTileSize();e.wrapLng&&(this._wrapLng=[Math.floor(t.project([0,e.wrapLng[0]]).x/i.x),Math.ceil(t.project([0,e.wrapLng[1]]).x/i.x)]),e.wrapLat&&(this._wrapLat=[Math.floor(t.project([e.wrapLat[0],0]).y/i.y),Math.ceil(t.project([e.wrapLat[1],0]).y/i.y)])}},_getTileSizeFac:function(){var t=this._map,e=t.getZoom(),i=this.options.maxNativeZoom;return i&&e>i?Math.round(t.getZoomScale(e)/t.getZoomScale(i)):1},_getTileSize:function(){var t=this._getTileSizeFac();return L.point(this.iipTileSize.x*t,this.iipTileSize.y*t)},_isValidTile:function(t){var e=this._map.options.crs;if(!e.infinite){var i=this._tileNumBounds;if(!e.wrapLng&&(t.x<i.min.x||t.x>i.max.x)||!e.wrapLat&&(t.y<i.min.y||t.y>i.max.y))return!1}var o=this._getZoomForUrl(),a=t.clone();if(this._wrapCoords(a),a.x<0||a.x>=this.iipGridSize[o].x||a.y<0||a.y>=this.iipGridSize[o].y)return!1;if(!this.options.bounds)return!0;var n=this._tileCoordsToBounds(t);return L.latLngBounds(this.options.bounds).intersects(n)},_getTileNumBounds:function(){var t=this._map.getPixelWorldBounds(),e=this._getTileSize();return t?L.bounds(this._vecDiv(t.min.clone(),e).floor(),this._vecDiv(t.max.clone(),e).ceil().subtract([1,1])):null},_tileCoordsToBounds:function(t){var e=this._map,i=this._getTileSize(),o=this._vecMul(t.clone(),i),a=o.add(i),n=e.wrapLatLng(e.unproject(o,t.z)),s=e.wrapLatLng(e.unproject(a,t.z));return new L.LatLngBounds(n,s)},_update:function(){if(this._map){var t=this._map,e=t.getPixelBounds(),i=t.getZoom(),o=this._getTileSize();if(i>this.options.maxZoom||i<this.options.minZoom)return this._clearBgBuffer(),void 0;var a=L.bounds(this._vecDiv(e.min.clone(),o).floor(),this._vecDiv(e.max.clone(),o).floor());this._addTiles(a),this.options.unloadInvisibleTiles&&this._removeOtherTiles(a)}},_vecDiv:function(t,e){return t.x/=e.x,t.y/=e.y,t},_vecMul:function(t,e){return t.x*=e.x,t.y*=e.y,t},_getTilePos:function(t){return this._vecMul(t.clone(),this._getTileSize()).subtract(this._map.getPixelOrigin())},getTileUrl:function(t){var e=this._url,i=this._getZoomForUrl();return this.iipCMap!==this.iipdefault.cMap&&(e+="&CMP="+this.iipCMap),this.iipInvertCMap!==this.iipdefault.invertCMap&&(e+="&INV"),this.iipContrast!==this.iipdefault.contrast&&(e+="&CNT="+this.iipContrast.toString()),this.iipGamma!==this.iipdefault.gamma&&(e+="&GAM="+(1/this.iipGamma).toFixed(4)),(this.iipMinValue[0]!==this.iipdefault.minValue[0]||this.iipMaxValue[0]!==this.iipdefault.maxValue[0])&&(e+="&MINMAX=1,"+this.iipMinValue[0].toString()+","+this.iipMaxValue[0].toString()),(this.iipMinValue[1]!==this.iipdefault.minValue[1]||this.iipMaxValue[1]!==this.iipdefault.maxValue[1])&&(e+="&MINMAX=2,"+this.iipMinValue[1].toString()+","+this.iipMaxValue[1].toString()),(this.iipMinValue[2]!==this.iipdefault.minValue[2]||this.iipMaxValue[2]!==this.iipdefault.maxValue[2])&&(e+="&MINMAX=3,"+this.iipMinValue[2].toString()+","+this.iipMaxValue[2].toString()),this.iipQuality!==this.iipdefault.quality&&(e+="&QLT="+this.iipQuality.toString()),e+"&JTL="+i.toString()+","+(t.x+this.iipGridSize[i].x*t.y).toString()},_initTile:function(t){if(L.DomUtil.addClass(t,"leaflet-tile"),this._getTileSizeFac()>1){var e=this._getTileSize();L.Browser.ie?t.style.msInterpolationMode="nearest-neighbor":t.style.imageRendering=L.Browser.chrome?"-webkit-optimize-speed":"-moz-crisp-edges",t.style.width=e.x+"px",t.style.height=e.y+"px"}t.onselectstart=L.Util.falseFn,t.onmousemove=L.Util.falseFn,L.Browser.ielt9&&this.options.opacity<1&&L.DomUtil.setOpacity(t,this.options.opacity),L.Browser.mobileWebkit3d&&(t.style.WebkitBackfaceVisibility="hidden")}}),L.tileLayer.iip=function(t,e){return new L.TileLayer.IIP(t,e)},L.Catalog={nmax:1e4,_csvToGeoJSON:function(t){var e=new RegExp("#|--|^$"),i=t.split("\n"),o={type:"FeatureCollection",features:[]};for(var a in i){var n=i[a];if(e.test(n)===!1){var s={type:"Feature",id:"",properties:{mags:[]},geometry:{type:"Point",coordinates:[0,0]}},r=s.geometry,l=s.properties,p=n.split(";");s.id=p[0],r.coordinates[0]=parseFloat(p[1]),r.coordinates[1]=parseFloat(p[2]);var c,h=p.slice(3);for(var u in h)c=parseFloat(h[u]),l.mags.push(isNaN(c)?"--":c);o.features.push(s)}}return o},_popup:function(t){var e="<div>";e+=this.objuri?'ID: <a href="'+L.Util.template(this.objuri,L.extend({ra:t.geometry.coordinates[0].toFixed(6),dec:t.geometry.coordinates[1].toFixed(6)}))+'" target="_blank">'+t.id+"</a></div>":"ID: "+t.id+"</div>",e+='<TABLE style="margin:auto;"><TBODY style="vertical-align:top;text-align:left;">';for(var i in this.properties)e+="<TR><TD>"+this.properties[i]+":</TD>"+"<TD>"+t.properties.mags[i].toString()+" "+this.units[i]+"</TD></TR>";return e+="</TBODY></TABLE>"}},L.Catalog.TwoMASS=L.extend({},L.Catalog,{name:"2MASS",attribution:"2MASS All-Sky Catalog of Point Sources (Cutri et al., 2003)",color:"red",maglim:17,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=II/246&-out=2MASS,RAJ2000,DEJ2000,Jmag,Hmag,Kmag&-out.meta=&-c={ra},{dec},eq=J2000&-c.bd={dra},{ddec}&-sort=_Kmagr&-out.max={nmax}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["J","H","K"],units:["","",""],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=II/246&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.Catalog.SDSS=L.extend({},L.Catalog,{name:"SDSS release 9",attribution:"SDSS Photometric Catalog, Release 9 (Adelman-McCarthy et al., 2012)",color:"yellow",maglim:25,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=V/139&-out=SDSS9,RAJ2000,DEJ2000,umag,gmag,rmag,imag,zmag&-out.meta=&-c={ra},{dec}&-c.bd={dra},{ddec}&-sort=imag&-out.max={nmax}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["u","g","r","i","z"],units:["","","","",""],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=V/139/sdss9&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.Catalog.PPMXL=L.extend({},L.Catalog,{name:"PPMXL",attribution:"PPM-Extended, positions and proper motions by Roeser et al. 2008",color:"green",maglim:20,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=I/317&-out=PPMXL,RAJ2000,DEJ2000,Jmag,Hmag,Kmag,b1mag,b2mag,r1mag,r2mag,imag,pmRA,pmDE&-out.meta=&-c={ra},{dec}&-c.bd={dra},{ddec}&-sort=_r&-out.max={nmax}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["J","H","K","b<sub>1</sub>","b<sub>2</sub>","r<sub>1</sub>","r<sub>2</sub>","i","&#956;<sub>&#593;</sub> cos &#948;","&#956;<sub>&#948;</sub>"],units:["","","","","","","","","mas/yr","mas/yr"],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=I/317&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.Catalog.Abell=L.extend({},L.Catalog,{name:"Abell clusters",attribution:"Rich Clusters of Galaxies (Abell et al. 1989) ",color:"orange",maglim:30,service:"CDS",uri:"/viz-bin/asu-tsv?&-mime=csv&-source=VII/110A&-out=ACO,_RAJ2000,_DEJ2000,m10,Rich,Dclass&-out.meta=&-c={ra},{dec}&-c.bd={dra},{ddec}&-sort=m10&-out.max={nmax}",toGeoJSON:L.Catalog._csvToGeoJSON,properties:["m<sub>10</sub>","Richness","D<sub>class</sub>"],units:["","",""],objuri:"http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-source=VII/110A&-c={ra},{dec},eq=J2000&-c.rs=0.2"}),L.Control.WCS=L.Control.extend({options:{position:"bottomleft",units:"HMS"},onAdd:function(t){var e=this._wcsinput=L.DomUtil.create("input","leaflet-control-wcs");return L.DomEvent.disableClickPropagation(e),e.type="text","webkitSpeechRecognition"in window&&e.setAttribute("x-webkit-speech","x-webkit-speech"),t.on("drag zoomend",this._onDrag,this),L.DomEvent.on(e,"focus",function(){this.setSelectionRange(0,this.value.length)},e),L.DomEvent.on(e,"change",this._onInputChange,this),this._wcsinput},onRemove:function(t){t.off("drag",this._onDrag)},_onDrag:function(){var t=this._map.getCenter();if(this._map.options.crs&&this._map.options.crs.pixelFlag)this._wcsinput.value=t.lng.toFixed(0)+" , "+t.lat.toFixed(0);else switch(this.options.units){case"HMS":this._wcsinput.value=this._latLngToHMSDMS(t);break;case"deg":this._wcsinput.value=t.lng.toFixed(5)+" , "+t.lat.toFixed(5);break;default:this._wcsinput.value=t.lng.toFixed(1)+" , "+t.lat.toFixed(1)}},_latLngToHMSDMS:function(t){var e=(t.lng+360)/360;e=24*(e-Math.floor(e));var i=Math.floor(e),o=60*(e-i),a=Math.floor(o),n=60*(o-a);n>=60&&(a++,n=0),60===a&&(i++,a=0);var s=i.toString()+":"+(10>a?"0":"")+a.toString()+":"+(10>n?"0":"")+n.toFixed(3),r=Math.abs(t.lat),l=t.lat<0?"-":"+",p=Math.floor(r);return o=60*(r-p),a=Math.floor(o),n=60*(o-a),n>=60&&(a++,n=0),60===a&&(i++,a=0),s+" "+l+(10>p?"0":"")+p.toString()+":"+(10>a?"0":"")+a.toString()+":"+(10>n?"0":"")+n.toFixed(2)},_onInputChange:function(){var t=/^(\d+\.?\d*)\s*,\s*\+?(-?\d+\.?\d*)/g,e=this._wcsinput.value,i=t.exec(e);i&&i.length>=3?this._map.panTo({lat:Number(i[2]),lng:Number(i[1])}):L.IIPUtils.requestURI("/cgi-bin/nph-sesame/-oI?"+e,"getting coordinates for "+e,this._getCoordinates,this,!0)},_getCoordinates:function(t,e){if(4===e.readyState)if(200===e.status){var i=/J\s(\d+\.?\d*)\s*,?\s*\+?(-?\d+\.?\d*)/g,o=e.responseText,a=i.exec(o);a&&a.length>=3?(t._map.panTo({lat:Number(a[2]),lng:Number(a[1])}),t._onDrag()):alert(o+": Unknown location")}else alert("There was a problem with the request to the Sesame service at CDS")}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.wcs=function(t){return new L.Control.WCS(t)},L.Control.Scale.WCS=L.Control.Scale.extend({options:{position:"bottomleft",maxWidth:128,metric:!1,imperial:!1,degrees:!0,pixels:!0,custom:!1,customScale:1,customUnits:"",planetRadius:6378137,updateWhenIdle:!1},_addScales:function(t,e,i){t.metric&&(this._mScale=L.DomUtil.create("div",e,i)),t.imperial&&(this._iScale=L.DomUtil.create("div",e,i)),t.degrees&&(this._dScale=L.DomUtil.create("div",e,i)),t.pixels&&(this._pScale=L.DomUtil.create("div",e,i)),t.custom&&(this._cScale=L.DomUtil.create("div",e,i)),this.angular=t.metric||t.imperial||t.degrees},_update:function(){var t=this.options,e=this._map,i=e.options.crs;if(t.pixels&&i.options&&i.options.nzoom){var o=Math.pow(2,i.options.nzoom-1-e.getZoom());this._updatePixels(o*t.maxWidth)}if(t.custom&&i.options&&i.options.nzoom){var a=Math.pow(2,i.options.nzoom-1-e.getZoom())*t.customScale;this._updateCustom(a*t.maxWidth,t.customUnits)}if(this.angular){var n=e.getCenter(),s=Math.cos(n.lat*Math.PI/180),r=Math.sqrt(this._jacobian(n))*s,l=r*t.maxWidth;t.metric&&this._updateMetric(l*Math.PI/180*t.planetRadius),t.imperial&&this._updateImperial(l*Math.PI/180*t.planetRadius),t.degrees&&this._updateDegrees(l)}},_jacobian:function(t){var e=this._map,i=e.project(t),o=e.unproject(i.add([10,0])),a=e.unproject(i.add([0,10]));return.01*Math.abs((o.lng-t.lng)*(a.lat-t.lat)-(a.lng-t.lng)*(o.lat-t.lat))},_updateCustom:function(t,e){var i=this._cScale;if(t>1e9){var o=1e-9*t,a=this._getRoundNum(o);this._updateScale(i,a+" G"+e,a/o)}else if(t>1e6){var n=1e-6*t,s=this._getRoundNum(n);this._updateScale(i,s+" M"+e,s/n)}else if(t>1e3){var r=.001*t,l=this._getRoundNum(r);this._updateScale(i,l+" k"+e,l/r)}else{var p=this._getRoundNum(t);this._updateScale(i,p+" "+e,p/t)}},_updatePixels:function(t){var e=this._pScale;if(t>1e6){var i=1e-6*t,o=this._getRoundNum(i);this._updateScale(e,o+" Mpx",o/i)}else if(t>1e3){var a=.001*t,n=this._getRoundNum(a);this._updateScale(e,n+" kpx",n/a)}else{var s=this._getRoundNum(t);this._updateScale(e,s+" px",s/t)}},_updateDegrees:function(t){var e=3600*t,i=this._dScale;if(1>e){var o=1e3*e,a=this._getRoundNum(o);this._updateScale(i,a+" mas",a/o)}else if(60>e){var n=this._getRoundNum(e);this._updateScale(i,n+" &#34;",n/e)}else if(3600>e){var s=60*t,r=this._getRoundNum(s);this._updateScale(i,r+" &#39;",r/s)}else{var l=this._getRoundNum(t);this._updateScale(i,l+" &#176;",l/t)}}}),L.control.scale.wcs=function(t){return new L.Control.Scale.WCS(t)},L.Control.Reticle=L.Control.extend({options:{position:"bottomleft"},onAdd:function(){var t=this._reticle=L.DomUtil.create("div","leaflet-reticle",this._map._controlContainer),e=t.style;e.position="absolute",e.left="50%",e.bottom="50%",e.textAlign="center",e.verticalAlign="middle",e.pointerEvents="none",t.innerHTML="";var i=this._container=L.DomUtil.create("div","leaflet-dummy");return i},onRemove:function(){this._reticle.parentNode.removeChild(this._reticle)}}),L.control.reticle=function(t){return new L.Control.Reticle(t)},L.Control.IIP=L.Control.extend({options:{title:"a control related to IIPImage",collapsed:!0,position:"topleft"},initialize:function(t,e){L.setOptions(this,e),this._className="leaflet-control-iip",this._id="leaflet-iipimage",this._layers=t},onAdd:function(){var t=this._className,e=this._id,i=this._container=L.DomUtil.create("div",t+" leaflet-bar");if(i.setAttribute("aria-haspopup",!0),L.DomEvent.disableClickPropagation(i).disableScrollPropagation(i),this._dialog=L.DomUtil.create("div",t+"-dialog",i),this.options.collapsed){L.Browser.android||L.DomEvent.on(i,"mouseover",this._expand,this).on(i,"mouseout",this._collapse,this);var o=this._toggle=L.DomUtil.create("a",t+"-toggle leaflet-bar",i);o.href="#",o.id=e+"-toggle",o.title=this.options.title,L.Browser.touch?L.DomEvent.on(o,"click",L.DomEvent.stop).on(o,"click",this._expand,this):L.DomEvent.on(o,"focus",this._expand,this),this._map.on("click",this._collapse,this)}else this._expand();return this._map.on("layeradd",this._checkIIP,this),this._container},_checkIIP:function(t){var e=t.layer;e&&e.iipdefault&&(this._layer=e,this._reloadFlag?e.once("load",this._resetDialog,this):(this._initDialog(),this._reloadFlag=!0))},_initDialog:function(){},_resetDialog:function(){this._dialog.innerHTML="",this._initDialog()},_addDialogLine:function(t){var e=L.DomUtil.create("div",this._className+"-element",this._dialog),i=L.DomUtil.create("span",this._className+"-label",e);return i.innerHTML=t,e},_expand:function(){L.DomUtil.addClass(this._container,this._className+"-expanded")},_collapse:function(){this._container.className=this._container.className.replace(" "+this._className+"-expanded","")},getActiveBaseLayer:function(){return this._activeBaseLayer},_findActiveBaseLayer:function(){var t=this._layers;this._prelayer=void 0;for(var e in t){var i=t[e];if(!i.overlay)if(i._map){if(this._map.hasLayer(i)&&i.iipdefault)return i}else this._prelayer=i}return void 0},_onInputChange:function(t,e,i){var o=e.split(/\[|\]/);o[1]?t[o[0]][parseInt(o[1],10)]=i:t[o[0]]=i,t.redraw()}}),L.control.iip=function(t,e){return new L.Control.IIP(t,e)},"undefined"!=typeof require)var $=require("jquery-browser");if(L.Control.IIP.Image=L.Control.IIP.extend({options:{title:"Image adjustment",collapsed:!0,cmap:"grey",position:"topleft"},initialize:function(t,e){L.setOptions(this,e),$.widget("ui.spinner",$.ui.spinner,{_precision:function(){return Math.max(0,Math.ceil(-Math.log(this.options.step)*Math.LOG10E))}}),this._className="leaflet-control-iip",this._id="leaflet-iipimage",this._layers=t},_initDialog:function(){var t,e=this,i=this._className,o=this._layer,a=["grey","jet","cold","hot"];t=this._addDialogLine("LUT:");var n=L.DomUtil.create("input","leaflet-cmap-inv",t);n.id="leaflet-invertcmap",n.type="button";var s=L.DomUtil.create("span",i+"-cmaps",t),r=[];for(var l in a)r[l]=document.createElement("input"),r[l].className="leaflet-cmap-"+a[l],r[l].type="button",r[l].name="button",r[l].cmap=a[l],s.appendChild(r[l]),a[l]===this.options.cmap&&(r[l].checked="checked");$("."+i+"-cmaps").buttonset(),$("."+i+"-cmaps :button").click(function(){e._onInputChange(o,"iipCMap",this.cmap)}),$("#leaflet-invertcmap").button(),L.DomEvent.on(n,"click",function(){e._onInputChange(o,"iipInvertCMap",!o.iipInvertCMap);var t=o.iipInvertCMap?"scaleY(-1.0)":"none";for(var i in a)L.Browser.ie?r[i].style.msTransform=t:L.Browser.webkit?r[i].style.webkitTransform=t:r[i].style.transform=t},this);var p=parseFloat((.01*(o.iipMaxValue[0]-o.iipMinValue[0])).toPrecision(1));this._addNumericalInput(o,"Min:","iipMinValue[0]","leaflet-minvalue",o.iipMinValue[0],p),this._addNumericalInput(o,"Max:","iipMaxValue[0]","leaflet-maxvalue",o.iipMaxValue[0],p),this._addNumericalInput(o,"Gamma:","iipGamma","leaflet-gammavalue",o.iipGamma,.05,.5,5),this._addNumericalInput(o,"Contrast:","iipContrast","leaflet-contrastvalue",o.iipContrast,.05,0,10),this._addNumericalInput(o,"JPEG quality:","iipQuality","leaflet-qualvalue",o.iipQuality,1,0,100)},_addNumericalInput:function(t,e,i,o,a,n,s,r){var l=this,p=this._addDialogLine(e),c=L.DomUtil.create("input","",p);return c.id=o,c.type="number",c.value=a,c.size=5,$("#"+c.id).spinner({start:function(){L.Browser.mobile&&$("#"+c.id).blur()},stop:function(){l._onInputChange(t,i,c.value),L.Browser.mobile&&$("#"+c.id).blur()},icons:{down:"icon-minus",up:"icon-plus"},step:n,min:s,max:r}),p}}),L.control.iip.image=function(t,e){return new L.Control.IIP.Image(t,e)},"undefined"!=typeof require)var $=require("jquery-browser");if(L.Control.IIP.Overlay=L.Control.IIP.extend({options:{title:"overlay menu",collapsed:!0,position:"topleft"},initialize:function(t,e){L.setOptions(this,e),this._className="leaflet-control-iip",this._id="leaflet-iipoverlay",this._layers=t},_initDialog:function(){var t,e=this._className,i=[L.Catalog.TwoMASS,L.Catalog.SDSS,L.Catalog.PPMXL,L.Catalog.Abell];t=this._addDialogLine('<a id="logo-cds" href="http://cds.u-strasbg.fr">&nbsp;</a> catalog:');var o=L.DomUtil.create("input",e+"-catalogs",t);o.id="leaflet-catalog-colorpicker",o.type="text",o.value="yellow",$(document).ready(function(){$("#"+o.id).spectrum({showInput:!0,clickoutFiresChange:!0,move:function(t){o.value=t.toHexString()}})});var a=L.DomUtil.create("select",e+"-catalogs",t),n=document.createElement("option");n.text="Choose catalog:",n.disabled=!0,n.selected=!0,a.add(n,null);for(var s in i)n=document.createElement("option"),n.text=i[s].name,a.add(n,null);!L.Browser.android&&this.options.collapsed&&(L.DomEvent.on(a,"mousedown",function(){L.DomEvent.off(this._container,"mouseout",this._collapse,this),this.collapsedOff=!0},this),L.DomEvent.on(this._container,"mouseover",function(){this.collapsedOff&&(L.DomEvent.on(this._container,"mouseout",this._collapse,this),this.collapsedOff=!1)},this));var r=L.DomUtil.create("input",e+"-catalogs",t);r.type="button",r.value="Go",L.DomEvent.on(r,"click",function(){var t=a.selectedIndex-1;if(t>=0){var e=i[t];e.color=o.value,a.selectedIndex=0,this._getCatalog(e)}},this),t=this._addDialogLine("Profile:");var l=L.DomUtil.create("input",e+"-profile",t);l.id="leaflet-profile-colorpicker",l.type="text",l.value="magenta",$(document).ready(function(){$("#"+l.id).spectrum({showInput:!0,clickoutFiresChange:!0,move:function(t){l.value=t.toHexString()}})});var p=L.DomUtil.create("input",e+"-profile-start",t);p.type="button",p.value="Start",L.DomEvent.on(p,"click",function(){if(this._profileLine)this._profileLine.spliceLatLngs(0,1,this._map.getCenter()),this._profileLine.redraw();else{var t=this._map,e=t.getCenter(),i=this._profileLine=L.polyline([e,e],{color:l.value,weight:7,opacity:.5});i.nameColor=l.value,i.addTo(t),t.on("drag",this._updateLine,this)}},this);var c=L.DomUtil.create("input",e+"-profile-end",t);c.type="button",c.value="End",L.DomEvent.on(c,"click",this._profileEnd,this)},_resetDialog:function(){},_getCatalog:function(t){var e=this,i=this._map.getCenter(),o=this._map.getBounds(),a=Math.abs(Math.cos(i.lat))*Math.PI/180,n=Math.abs(o.getWest()-o.getEast()),s=Math.abs(o.getNorth()-o.getSouth());1e-4>s&&(s=1e-4),a>0&&1e-4>n*a&&(n=1e-4/a);var r=new L.LayerGroup(null),l=this._map._layerControl;r.notReady=!0,l&&(l.addOverlay(r,t.name),l.options.collapsed&&l._expand()),L.IIPUtils.requestURI(L.Util.template(t.uri,L.extend({ra:i.lng.toFixed(6),dec:i.lat.toFixed(6),dra:n.toFixed(4),ddec:s.toFixed(4),nmax:t.nmax})),"getting "+t.service+" data",function(i,o){e._loadCatalog(t,r,i,o)},this,!0)},_loadCatalog:function(t,e,i,o){if(4===o.readyState)if(200===o.status){var a=o.responseText,n=t.toGeoJSON(a),s=L.geoJson(n,{onEachFeature:function(e,i){e.properties&&e.properties.mags&&i.bindPopup(t._popup(e))},pointToLayer:function(e,i){return L.circleMarker(i,{radius:e.properties.mags[0]?8+t.maglim-e.properties.mags[0]:8})},style:function(){return{color:t.color,weight:2}}});s.nameColor=t.color,s.addTo(i._map);var r=i._map._layerControl;r&&(r.removeLayer(e),r.addOverlay(s,t.name+" ("+n.features.length.toString()+" entries)"),r.options.collapsed&&r._collapse())}else alert("There was a problem with the request to "+t.service+".")},_updateLine:function(){var t=this._map,e=(t.getCenter(),t.options.crs.options.nzoom-1),i=this._profileLine,o=i.getLatLngs(),a=t.project(o[0],e),n=t.project(t.getCenter(),e);Math.abs(a.x-n.x)>Math.abs(a.y-n.y)?n.y=a.y:n.x=a.x,this._profileLine.spliceLatLngs(1,1,t.unproject(n,e)),this._profileLine.redraw()},_profileEnd:function(){var t=this._map,e=(t.getCenter(),this._profileLine);t.off("drag",this._updateLine,this),this._profileLine=void 0;
var i=document.createElement("div"),o=document.createElement("div");i.id="leaflet-profile-plot",o.className="leaflet-control-activity",i.appendChild(o),e.bindPopup(i,{minWidth:16,maxWidth:1024,closeOnClick:!1}).openPopup();var a,n,s=t.options.crs.options.nzoom-1,r=e.getLatLngs(),l=t.project(r[0],s),p=t.project(r[1],s);p.x<l.x&&(a=p.x,p.x=l.x,l.x=a),p.y<l.y&&(n=p.y,p.y=l.y,l.y=n),L.IIPUtils.requestURI(this._layer._url.replace(/\&.*$/g,"")+"&PFL="+s.toString()+":"+l.x.toFixed(0)+","+l.y.toFixed(0)+"-"+p.x.toFixed(0)+","+p.y.toFixed(0),"getting IIP layer profile",this._plotProfile,e)},_getMeasurementString:function(){var t,e,i,o=this._currentLatLng,a=this._markers[this._markers.length-1].getLatLng();return t=this._measurementRunningTotal+L.IIPUtils.distance(o,a),t>=1?i="&#176;":(t*=60,t>=1?i="&#39;":(t*=60,i="&#34;")),e=t.toFixed(2)+i},_plotProfile:function(t,e){if(4===e.readyState&&200===e.status){var i=JSON.parse(e.responseText),o=i.profile,a=t._map._layerControl,n=document.getElementById("leaflet-profile-plot");a&&a.addOverlay(t,"Image profile"),$(document).ready(function(){$.jqplot("leaflet-profile-plot",[o],{title:"Image profile",axes:{xaxis:{label:"position along line",labelRenderer:$.jqplot.CanvasAxisLabelRenderer,pad:1},yaxis:{label:"pixel values",labelRenderer:$.jqplot.CanvasAxisLabelRenderer,pad:1}},cursor:{show:!0,zoom:!0},seriesDefaults:{lineWidth:2,showMarker:!1}})}),n.removeChild(n.childNodes[0]),t._popup.update()}}}),L.control.iip.overlay=function(t){return new L.Control.IIP.Overlay(t)},"undefined"!=typeof require)var $=require("jquery-browser");if(L.Control.Layers.IIP=L.Control.Layers.extend({options:{title:"overlay menu",collapsed:!0,position:"topright",autoZIndex:!0,fileMenu:!1,fileURL:"/fcgi-bin/iipsrv.fcgi?FIF=",fileRoot:"",fileTreeScript:"visiomatic/dist/filetree.php",fileProcessScript:"visiomatic/dist/processfits.php"},onAdd:function(t){return t._layerControl=this,this._initLayout(),this._update(),this._container},_initLayout:function(){var t="leaflet-control-layers",e=this._container=L.DomUtil.create("div",t);e.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(e,"click",L.DomEvent.stopPropagation):L.DomEvent.disableClickPropagation(e).disableScrollPropagation(e);var i=this._form=L.DomUtil.create("form",t+"-list");if(this.options.collapsed){L.Browser.android||L.DomEvent.on(e,{mouseover:this._expand,mouseout:this._collapse},this);var o=this._layersLink=L.DomUtil.create("a",t+"-toggle",e);o.href="#",o.title="Layers",L.Browser.touch?L.DomEvent.on(o,"click",L.DomEvent.stop).on(o,"click",this._expand,this):L.DomEvent.on(o,"focus",this._expand,this),L.DomEvent.on(i,"click",function(){setTimeout(L.bind(this._onInputClick,this),0)},this),this._map.on("click",this._collapse,this)}else this._expand();if(this._baseLayersList=L.DomUtil.create("div",t+"-base",i),this.options.fileMenu){var a=this._addButton=L.DomUtil.create("input",t+"-add",i);a.type="button",a.value="Add...",L.DomEvent.on(a,"click",this._openFileMenu,this)}this._separator=L.DomUtil.create("div",t+"-separator",i),this._overlaysList=L.DomUtil.create("div",t+"-overlays",i),e.appendChild(i)},_addItem:function(t){var e=this,i=L.DomUtil.create("div","leaflet-control-layers-item"),o=L.DomUtil.create("div","leaflet-control-layers-select",i);if(t.layer.notReady)L.DomUtil.create("div","leaflet-control-activity",o);else{var a,n=this._map.hasLayer(t.layer);t.overlay?(a=document.createElement("input"),a.type="checkbox",a.className="leaflet-control-layers-selector",a.defaultChecked=n):a=this._createRadioElement("leaflet-base-layers",n),a.layerId=L.stamp(t.layer),L.DomEvent.on(a,"click",this._onInputClick,this),o.appendChild(a)}var s=L.DomUtil.create("div","leaflet-control-layers-name",i);s.innerHTML=" "+t.name,s.style.textShadow="0px 0px 5px "+t.layer.nameColor;var r=L.DomUtil.create("input","leaflet-control-layers-trash",i);r.type="button",L.DomEvent.on(r,"click",function(){e.removeLayer(t.layer),t.notReady||e._map.removeLayer(t.layer)},this);var l=t.overlay?this._overlaysList:this._baseLayersList;return l.appendChild(i),i},_onInputClick:function(){var t,e,i,o=this._form.getElementsByTagName("input"),a=o.length;for(this._handlingClick=!0,t=0;a>t;t++)e=o[t],"layerId"in e&&(i=this._layers[e.layerId],e.checked&&!this._map.hasLayer(i.layer)?i.layer.addTo(this._map):!e.checked&&this._map.hasLayer(i.layer)&&this._map.removeLayer(i.layer));this._handlingClick=!1},_addDialogLine:function(t,e){var i=L.DomUtil.create("div",this._className+"-element",e),o=L.DomUtil.create("span",this._className+"-label",i);return o.innerHTML=t,i},_openFileMenu:function(){var t=this,e=L.DomUtil.create("div","leaflet-control-filemenu",this._map._controlContainer);e.title="Open file",this._addButton.disabled=!0,L.DomEvent.disableClickPropagation(e).disableScrollPropagation(e),$(".leaflet-control-filemenu").dialog({appendTo:"body",close:function(){L.DomUtil.remove(e),t._addButton.disabled=!1},show:{effect:"clip",duration:250},hide:{effect:"clip",duration:250},height:200});var i=L.DomUtil.create("div","leaflet-control-filetree",e);i.id="leaflet-filetree",$(document).ready(function(){$("#leaflet-filetree").fileTree({root:t.options.fileRoot,script:t.options.fileTreeScript},function(e){var i,o=t._map._layerControl,a=e.replace(/(^.*\/|\..*$)/g,"");o&&(i=new L.LayerGroup(null),i.notReady=!0,o.addBaseLayer(i,"converting "+a+"..."),o.options.collapsed&&o._expand()),$.post(t.options.fileProcessScript,{fitsname:e},function(e){e=e.trim();var o=L.tileLayer.iip(t.options.fileURL+e,{title:a});o.iipMetaReady?t._updateBaseLayer(i,o):o.once("metaload",function(){t._updateBaseLayer(i,o)})})})})},_updateBaseLayer:function(t,e){var i=this._map,o=i._layerControl;o.removeLayer(t),i.eachLayer(i.removeLayer),e.addTo(i),o.addBaseLayer(e,e._title),i.fire("baselayerchange"),o.options.collapsed&&o._collapse()}}),L.control.layers.iip=function(t,e,i){return new L.Control.Layers.IIP(t,e,i)},"undefined"!=typeof require)var jQuery=require("jquery-browser");!function(){L.Control.FullScreen=L.Control.extend({options:{position:"topleft",title:"Full Screen",forceSeparateButton:!1},onAdd:function(t){var e,i="leaflet-control-zoom-fullscreen";return e=t.zoomControl&&!this.options.forceSeparateButton?t.zoomControl._container:L.DomUtil.create("div","leaflet-bar"),this._createButton(this.options.title,i,e,this.toogleFullScreen,t),e},_createButton:function(e,i,o,a,n){var s=L.DomUtil.create("a",i,o);return s.href="#",s.title=e,L.DomEvent.addListener(s,"click",L.DomEvent.stopPropagation).addListener(s,"click",L.DomEvent.preventDefault).addListener(s,"click",a,n),L.DomEvent.addListener(o,t.fullScreenEventName,L.DomEvent.stopPropagation).addListener(o,t.fullScreenEventName,L.DomEvent.preventDefault).addListener(o,t.fullScreenEventName,this._handleEscKey,n),L.DomEvent.addListener(document,t.fullScreenEventName,L.DomEvent.stopPropagation).addListener(document,t.fullScreenEventName,L.DomEvent.preventDefault).addListener(document,t.fullScreenEventName,this._handleEscKey,n),s},toogleFullScreen:function(){this._exitFired=!1;var e=this._container;this._isFullscreen?(t.supportsFullScreen?t.cancelFullScreen(e):L.DomUtil.removeClass(e,"leaflet-pseudo-fullscreen"),this.invalidateSize(),this.fire("exitFullscreen"),this._exitFired=!0,this._isFullscreen=!1):(t.supportsFullScreen?t.requestFullScreen(e):L.DomUtil.addClass(e,"leaflet-pseudo-fullscreen"),this.invalidateSize(),this.fire("enterFullscreen"),this._isFullscreen=!0)},_handleEscKey:function(){t.isFullScreen(this)||this._exitFired||(this.fire("exitFullscreen"),this._exitFired=!0,this._isFullscreen=!1)}}),L.Map.addInitHook(function(){this.options.fullscreenControl&&(this.fullscreenControl=L.control.fullscreen(this.options.fullscreenControlOptions),this.addControl(this.fullscreenControl))}),L.control.fullscreen=function(t){return new L.Control.FullScreen(t)};var t={supportsFullScreen:!1,isFullScreen:function(){return!1},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},e="webkit moz o ms khtml".split(" ");if("undefined"!=typeof document.exitFullscreen)t.supportsFullScreen=!0;else for(var i=0,o=e.length;o>i;i++)if(t.prefix=e[i],"undefined"!=typeof document[t.prefix+"CancelFullScreen"]){t.supportsFullScreen=!0;break}t.supportsFullScreen&&(t.fullScreenEventName=t.prefix+"fullscreenchange",t.isFullScreen=function(){switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}},t.requestFullScreen=function(t){return""===this.prefix?t.requestFullscreen():t[this.prefix+"RequestFullScreen"]()},t.cancelFullScreen=function(){return""===this.prefix?document.exitFullscreen():document[this.prefix+"CancelFullScreen"]()}),"undefined"!=typeof jQuery&&(jQuery.fn.requestFullScreen=function(){return this.each(function(){var e=jQuery(this);t.supportsFullScreen&&t.requestFullScreen(e)})}),window.fullScreenApi=t}(),L.Control.ExtraMap=L.Control.extend({options:{position:"bottomright",toggleDisplay:!0,zoomLevelOffset:-5,zoomLevelFixed:!1,zoomAnimation:!1,autoToggleDisplay:!1,width:150,height:150,aimingRectOptions:{color:"#ff7800",weight:1,clickable:!1,renderer:L.Canvas.instance},shadowRectOptions:{color:"#000000",weight:1,clickable:!1,opacity:0,fillOpacity:0}},hideText:"Hide map",showText:"Show map",initialize:function(t,e){L.Util.setOptions(this,e),this.options.aimingRectOptions.clickable=!1,this.options.shadowRectOptions.clickable=!1,this._layer=t},onAdd:function(t){return this._mainMap=t,this._container=L.DomUtil.create("div","leaflet-control-extramap"),this._container.style.width=this.options.width+"px",this._container.style.height=this.options.height+"px",L.DomEvent.disableClickPropagation(this._container),L.DomEvent.on(this._container,"mousewheel",L.DomEvent.stopPropagation),this._extraMap=new L.Map(this._container,{attributionControl:!1,zoomControl:!1,zoomAnimation:this.options.zoomAnimation,autoToggleDisplay:this.options.autoToggleDisplay,touchZoom:!this.options.zoomLevelFixed,scrollWheelZoom:!this.options.zoomLevelFixed,doubleClickZoom:!this.options.zoomLevelFixed,boxZoom:!this.options.zoomLevelFixed}),this._layer.addTo(this._extraMap),this._userToggledDisplay=!1,this._minimized=!1,this.options.toggleDisplay&&this._addToggleButton(),this._layer.once("metaload",function(){this._mainMap.whenReady(L.Util.bind(function(){this._extraMap.whenReady(L.Util.bind(function(){var t=this._getMapLatLngBounds(this._mainMap);this._aimingRect=L.polygon(t,this.options.aimingRectOptions).addTo(this._extraMap),this._shadowRect=L.polygon(t,this.options.shadowRectOptions).addTo(this._extraMap),this._mainMap.on("moveend",this._onMainMapMoved,this),this._mainMap.on("move",this._onMainMapMoving,this),this._extraMap.on("movestart",this._onExtraMapMoveStarted,this),this._extraMap.on("move",this._onExtraMapMoving,this),this._extraMap.on("moveend",this._onExtraMapMoved,this),this._extraMap.setView(this._mainMap.getCenter(),this._decideZoom(!0)),this._setDisplay(this._decideMinimized())},this))},this))},this),this._container},addTo:function(t){return L.Control.prototype.addTo.call(this,t),this},onRemove:function(){this._mainMap.off("moveend",this._onMainMapMoved,this),this._mainMap.off("move",this._onMainMapMoving,this),this._extraMap.off("moveend",this._onExtraMapMoved,this),this._extraMap.removeLayer(this._layer)},_getMapLatLngBounds:function(t){var e=t.getPixelBounds(),i=e.min,o=e.max;return[t.unproject([i.x,i.y]),t.unproject([o.x,i.y]),t.unproject([o.x,o.y]),t.unproject([i.x,o.y])]},_addToggleButton:function(){this._toggleDisplayButton=this.options.toggleDisplay?this._createButton("",this.hideText,"leaflet-control-extramap-toggle-display",this._container,this._toggleDisplayButtonClicked,this):void 0},_createButton:function(t,e,i,o,a,n){var s=L.DomUtil.create("a",i,o);s.innerHTML=t,s.href="#",s.title=e;var r=L.DomEvent.stopPropagation;return L.DomEvent.on(s,"click",r).on(s,"mousedown",r).on(s,"dblclick",r).on(s,"click",L.DomEvent.preventDefault).on(s,"click",a,n),s},_toggleDisplayButtonClicked:function(){this._userToggledDisplay=!0,this._minimized?(this._restore(),this._toggleDisplayButton.title=this.hideText):(this._minimize(),this._toggleDisplayButton.title=this.showText)},_setDisplay:function(t){t!==this._minimized&&(this._minimized?this._restore():this._minimize())},_minimize:function(){this.options.toggleDisplay?(this._container.style.width="19px",this._container.style.height="19px",this._toggleDisplayButton.className+=" minimized"):this._container.style.display="none",this._minimized=!0},_restore:function(){this.options.toggleDisplay?(this._container.style.width=this.options.width+"px",this._container.style.height=this.options.height+"px",this._toggleDisplayButton.className=this._toggleDisplayButton.className.replace(/(?:^|\s)minimized(?!\S)/g,"")):this._container.style.display="block",this._minimized=!1},_onMainMapMoved:function(){this._extraMapMoving?this._extraMapMoving=!1:(this._mainMapMoving=!0,this._extraMap.setView(this._mainMap.getCenter(),this._decideZoom(!0)),this._setDisplay(this._decideMinimized())),this._aimingRect.setLatLngs(this._getMapLatLngBounds(this._mainMap))},_onMainMapMoving:function(){this._aimingRect.setLatLngs(this._getMapLatLngBounds(this._mainMap))},_onExtraMapMoveStarted:function(){this._lastAimingRectPosition=this._aimingRect.getLatLngs()},_onExtraMapMoving:function(){!this._mainMapMoving&&this._lastAimingRectPosition&&(this._shadowRect.setLatLngs(this._lastAimingRectPosition),this._shadowRect.setStyle({opacity:0,fillOpacity:0}))},_onExtraMapMoved:function(){this._mainMapMoving?this._mainMapMoving=!1:(this._extraMapMoving=!0,this._mainMap.setView(this._extraMap.getCenter(),this._decideZoom(!1)),this._shadowRect.setStyle({opacity:0,fillOpacity:0}))},_decideZoom:function(t){if(this.options.zoomLevelFixed)return t?this.options.zoomLevelFixed:this._mainMap.getZoom();if(t)return this._mainMap.getZoom()+this.options.zoomLevelOffset;var e,i=this._extraMap.getZoom()-this._mainMap.getZoom(),o=this._extraMap.getZoom()-this.options.zoomLevelOffset;return i>this.options.zoomLevelOffset&&this._mainMap.getZoom()<this._extraMap.getMinZoom()-this.options.zoomLevelOffset?this._extraMap.getZoom()>this._lastExtraMapZoom?(e=this._mainMap.getZoom()+1,this._extraMap.setZoom(this._extraMap.getZoom()-1)):e=this._mainMap.getZoom():e=o,this._lastExtraMapZoom=this._extraMap.getZoom(),e},_decideMinimized:function(){return this._userToggledDisplay?this._minimized:this.options.autoToggleDisplay?this._mainMap.getBounds().contains(this._extraMap.getBounds())?!0:!1:this._minimized}}),L.Map.mergeOptions({extraMapControl:!1}),L.Map.addInitHook(function(){this.options.extraMapControl&&(this.extraMapControl=(new L.Control.ExtraMap).addTo(this))}),L.control.extramap=function(t){return new L.Control.ExtraMap(t)},L.Control.Attribution.include({_update:function(){if(this._map){var t=[];for(var e in this._attributions)this._attributions[e]&&t.push(e);var i=[];this.options.prefix&&i.push(this.options.prefix),t.length&&i.push(t.join(", ")),this._container.innerHTML=i.join(" &#169; ")}}}),L.Map.addInitHook(function(){this.options.visiomaticLogo!==!1&&this.options.attributionControl&&this.attributionControl.setPrefix('<a id="logo-visiomatic" class="leaflet-control-attribution-logo"href="http://visiomatic.org">&nbsp;</a><a id="logo-iipimage" class="leaflet-control-attribution-logo"href="http://iipimage.sourceforge.net">&nbsp;</a><a id="logo-leaflet" class="leaflet-control-attribution-logo"href="http://leafletjs.com">&nbsp;</a>')});